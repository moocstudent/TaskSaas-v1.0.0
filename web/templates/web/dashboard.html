{% extends 'layout/manage.html' %}
{% load dashboard %}
{% load issues %}
{% block title %}{% endblock %}

{% block css %}
    <style>

        .layui-layer-btn0 {
            width: 25%;
            position: relative;
        }

        .layui-layer-btn1 {
            width: 25%;
            position: relative;
        }

        .layui-layer-btn2 {
            width: 25%;
            position: relative;
        }

        .layui-layer-btn3 {
            width: 25%;
            position: relative;
        }

        .layui-layer-btn4 {
            width: 25%;
            position: relative;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 17px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .table-right > tbody > tr > td.label-left {
            width: 90px;
        }

        .table-right > tbody > tr > td {
            border: 0;
        }

        .status-count {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-count .count {
            font-size: 25px;
        }

        .status-count a {
            text-decoration: none;
        }

        .user-item .title {
            margin-bottom: 20px;
        }

        .user-item .avatar, .top-10 .avatar {
            float: left;
            margin-right: 10px;
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: #304659;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
        }

        .user-item .text {
            line-height: 30px;
        }

        .top-10 .avatar {
            margin-right: 0;
        }

        .top-10 td {
            padding: 5px 10px;
        }

        .top-10 .table > tbody > tr > td {
            border-top: 0;
            border-bottom: 1px solid #ddd;
        }
    </style>

{% endblock %}

{% block content %}
    <div class="container-fluid" style="margin-top: 20px">
        <div class="row">

            <div class="col-md-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-bar-chart" aria-hidden="true"></i>
                        æ–°å¢é—®é¢˜è¶‹åŠ¿
                        <label class="fa! switch">
                            <input type="checkbox" id="mytaskToggle" onclick="mytaskTrigger()">
                            <span class="slider round"></span>
                        </label>
                        åªçœ‹ä¸æˆ‘ç›¸å…³
                    </div>
                    <div class="panel-body">
                        <div id="chart" style="width:100%;min-height:200px">

                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="fa fa-quora" aria-hidden="true"></i>
                                é—®é¢˜
                            </div>
                            <div class="panel-body">
                                {% for key,item in status_dict.items %}
                                    <div class="col-sm-4 status-count">
                                        <a href="{% url 'issues' project_id=request.web.project.id %}?status={{ key }}&issues_type={{ type_ids }}">
                                            <div class="count">{{ item.count }}</div>
                                            <div>{{ item.text }}</div>
                                        </a>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="fa fa-user" aria-hidden="true"></i>
                                é¡¹ç›®æˆå‘˜
                                <a style="float: right;" class="layui-btn layui-btn-normal layui-btn-xs"
                                   data-toggle="modal" data-target="#inviteModal">é‚€è¯·æˆå‘˜</a>
                            </div>
                            <div class="panel-body user-item">
                                <div class="col-sm-12 title">åˆ›å»ºè€…</div>
                                <div class="clearfix" style="margin-bottom: 30px;">
                                    <div class="col-sm-4">
                                        <div class="layui-row ws-docs-anim">
                                            {#                                       id {{ request.web.project.creator.id }}#}
                                            <div class="avatar layui-anim" data-anim="layui-anim-rotate">
                                                {% if  request.web.project.creator.git_avatar %}
                                                    <img class="avatar"
                                                         src="{{ request.web.project.creator.git_avatar }}" alt="">
                                                {% else %}
                                                    {{ request.web.project.creator.username.0|upper }}
                                                {% endif %}

                                            </div>
                                        </div>
                                        <div class="text">{{ request.web.project.creator.username }}</div>
                                    </div>
                                </div>
                                <div class="col-sm-12 title">å‚ä¸è€…</div>
                                <div>
                                    {% for item in join_user %}
                                        <div class="col-sm-4">
                                            <div class="layui-row ws-docs-anim">
                                                <div class="avatar layui-anim" data-anim="layui-anim-rotate">
                                                    {% if item.2 %}
                                                        <img src="{{ item.2 }}" alt="">
                                                    {% else %}
                                                        <div>{{ item.1.0 |upper }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="text">{{ item.1 }}</div>
                                        </div>
                                    {% endfor %}
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade in" id="inviteModal" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="myModalLabel">é‚€è¯·æˆå‘˜</h4>
                        </div>
                        <div class="modal-body" style="padding-right: 40px;">
                            <form id="inviteForm">
                                {% csrf_token %}
                                {% for item in invite_form %}
                                    <div class="form-group">
                                        <label for="{{ item.id_for_label }}">{{ item.label }}</label>
                                        <span>{% if  item.help_text %}ï¼ˆ{{ item.help_text }}ï¼‰{% endif %}</span>
                                        {{ item }}
                                        <span class="error-msg"></span>
                                    </div>
                                {% endfor %}
                                <button type="button" class="btn btn-success" id="btnGenInviteCode">ç”Ÿæˆé‚€è¯·ç </button>
                            </form>
                            <div id="inviteArea" class="hide">
                                <hr/>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-btn">
                                            <input type="button" value="é‚€è¯·é“¾æ¥" class="btn btn-default">
                                        </div>
                                        <input type="text" class="form-control" id="inviteUrl">
                                        <div class="input-group-btn">
                                            <input type="button" value="å¤åˆ¶é“¾æ¥" class="btn btn-primary"
                                                   id="btnCopyUrl">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            {#        when deadline occur ,show the tip card in dashboard#}
            {#        test btn#}
            {#            <button type="button" class="layui-btn layui-btn-primary" lay-on="test-more-stack">#}
            {#                <span class="layui-badge-dot"></span> å¤šçª—å£æ¨¡å¼ + å±‚å ç½®é¡¶ + Esc å…³é—­#}
            {#            </button>#}

            <div class="col-md-4">

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-cog title-icon"></i>
                        è¯¦ç»†
                    </div>
                    <div class="panel-body">
                        <table class="table table-right">
                            <tbody>
                            <tr>
                                <td class="label-left">é¡¹ç›®åç§° ï¼š</td>
                                <td>{{ request.web.project.name }}-({{ request.web.project.id }})</td>

                            </tr>
                            <tr>
                                <td class="label-left">é¡¹ç›®æè¿° ï¼š</td>
                                <td>{{ request.web.project.desc }}</td>
                            </tr>
                            <tr>
                                <td class="label-left">åˆ›å»ºæ—¶é—´ ï¼š</td>
                                <td>{{ request.web.project.create_datetime }}</td>
                            </tr>
                            <tr>
                                <td class="label-left">é¡¹ç›®ç©ºé—´ ï¼š</td>
                                <td> {% user_space request.web.project.user_space %}
                                    / {{ request.web.price_policy.project_space }} GB
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-list-ul" aria-hidden="true"></i>
                        åŠ¨æ€ {{ top_ten_size }} æ¬¡
                    </div>
                    <div class="panel-body top-10">
                        <table class="table"
                               style="word-wrap:break-word;word-break:break-all;height: 300px;min-height: 100vh;display: block;overflow-y: scroll;">
                            <tbody>
                            {% for key,item in top_ten.items %}
                                {#                                                                {{ key }}#}
                                {#                                {{ item }}#}
                                <tr>
                                    <td style="width: 46px;">
                                        {% if item.avatar %}
                                            <img class="avatar" src="{{ item.avatar }}" alt="">
                                        {% else %}
                                            <div class="avatar">{{ item.creator.0|upper }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.type == 1 %}
                                            <div>{{ item.creator }}</div>
                                            <label>
                                                åˆ›å»ºäº†
                                                <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                {#                                            ç»™ {{ item.assign.username }}#}
                                                <label style="text-overflow: ellipsis;">ã€{{ item.title }}ã€‘</label>
                                            </label>
                                            <label style="width: 300px;">
                                                åˆ›å»ºäº:{{ key }}
                                            </label>
                                        {% endif %}
                                        {% if item.type == 2 %}
                                            <div>{{ item.creator }}</div>
                                            <label>æ›´æ–°äº†
                                                <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                {#                                            ç»™ {{ item.assign.username }}#}
                                                <label>ã€{{ item.title }}ã€‘</label>
                                                <label>{{ item.desc }}</label>
                                            </label>
                                            <label style="width: 300px;">
                                                æ›´æ–°äº:{{ key }}
                                            </label>
                                        {% endif %}
                                        {% if item.type == 3 %}
                                            <div>{{ item.creator }}</div>
                                            <label>å›å¤äº† {% if item.reply_to %}{{ item.reply_to }}{% endif %}
                                                <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                {#                                            ç»™ {{ item.assign.username }}#}
                                                <label style="text-overflow: ellipsis;">ã€{{ item.title }}ã€‘</label>
                                                <br>
                                                >> <label style="text-overflow: ellipsis;">{{ item.desc }}</label>
                                            </label>
                                            {#                                            <div>æŒ‡æ´¾#}
                                            {#                                                ç»™ {{ item.assign }}#}
                                            {#                                            </div>#}
                                            <label style="width: 300px;">
                                                å›å¤äº:{{ key }}
                                            </label>

                                        {% endif %}

                                    </td>

                                </tr>

                            {% endfor %}
                            </tbody>
                        </table>

                    </div>
                </div>

            </div>
        </div>
    </div>
    {#    <div {% load dashboard %} hidden="hidden"></div>#}
    <input id="echarts_data" value="{{ echarts_data }}" hidden="hidden"/>
    <input id="tasks_count" value="{{ tasks_count }}" hidden="hidden"/>
    <input id="funcs_count" value="{{ funcs_count }}" hidden="hidden"/>
    <input id="bugs_count" value="{{ bugs_count }}" hidden="hidden"/>
    <input id="demand_count" value="{{ demand_count }}" hidden="hidden"/>
    <input id="issues_types" value="{{ issues_types }}" hidden="hidden"/>
    <input id="status_choices" value="{{ status_choices }}" hidden="hidden"/>
    <input id="pid" value="{{ request.web.project.id }}" hidden="hidden"/>
    <input id="type_ids" value="{{ type_ids }}" hidden="hidden"/>
    <input id="all_type_ids" value="{{ all_type_ids }}" hidden="hidden"/>
    <input id="remind_infos" value="{{ remind_infos }}" hidden="hidden"/>
    <input id="csrf_token" value="{{ csrf_token }}" hidden="hidden"/>
{% endblock %}

{% block js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"
            integrity="sha512-EmNxF3E6bM0Xg1zvmkeYD3HDBeGxtsG92IxFt1myNZhXdCav9MzvuH/zNMBU1DmIPN6njrhX1VTbqdJxQ2wHDg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById("chart"));
        var echartsData = JSON.parse(document.getElementById("echarts_data").value);
        console.log('echartsData', echartsData);
        const yDataNames = ['é‡æ–°æ‰“å¼€', 'å·²å…³é—­', 'å¾…åé¦ˆ', 'å·²å¿½ç•¥', 'å·²è§£å†³', 'å¤„ç†ä¸­', 'æ–°å»º']
        var tasksCount = JSON.parse(document.getElementById("tasks_count").value);
        console.log('tasksCount', tasksCount);
        if (tasksCount.length == 0) {
            console.log('rray(yDataNames.lengt')
            tasksCount = Array(yDataNames.length).fill(0);
        }
        var funcsCount = JSON.parse(document.getElementById("funcs_count").value);
        if (funcsCount.length == 0) {
            funcsCount = Array(yDataNames.length).fill(0);
        }
        console.log('funcsCount', funcsCount)
        var bugsCount = JSON.parse(document.getElementById("bugs_count").value);
        if (bugsCount.length == 0) {
            bugsCount = Array(yDataNames.length).fill(0);
        }
        var demandCount = JSON.parse(document.getElementById("demand_count").value);
        if (demandCount.length == 0) {
            demandCount = Array(yDataNames.length).fill(0);
        }
        var issues_types = eval(document.getElementById("issues_types"));
        var status_choices = JSON.parse(document.getElementById("status_choices").value);
        var type_ids = document.getElementById("type_ids").value;
        var all_type_ids = document.getElementById("all_type_ids").value;
        var remind_infos = eval(document.getElementById("remind_infos").value);
        console.log('all_type_ids ', all_type_ids);
        console.log('remind_infos ', remind_infos);
        console.log('remind_infos sz ', remind_infos.length);
        if (type_ids) {
            {#if (type_ids.indexOf(",")>-1){#}
            type_ids = type_ids.split(',')
            {% comment %}  }{% endcomment %}
        }
        if (all_type_ids) {
            {#if (type_ids.indexOf(",")>-1){#}
            all_type_ids = all_type_ids.split(',')
            {% comment %}  }{% endcomment %}
        }
        var pid = JSON.parse(document.getElementById("pid").value);

        const dashboardLegendTriggerKey = "mainLegendTrigger" + '{{ request.web.user.id }}' + '_' + '{{ request.web.project.id }}'
        console.log('dashboardLegendTriggerKey', dashboardLegendTriggerKey)

        const mytaskTriggerKey = "mytaskTrigger" + '{{ request.web.user.id }}' + '_' + '{{ request.web.project.id }}'
        console.log('mytaskTriggerKey', mytaskTriggerKey)


        // åŸºäºå‡†å¤‡å¥½çš„domï¼Œåˆå§‹åŒ–echartså®ä¾‹
        myChart.showLoading();


        option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    // Use axis to trigger tooltip
                    type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
                }
            },
            legend: {},
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'value',
                triggerEvent: true,
            },
            yAxis: {
                type: 'category',
                data: yDataNames,
                triggerEvent: true,
            },
            series: [
                {
                    name: 'ä»»åŠ¡',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: tasksCount
                },
                {
                    name: 'åŠŸèƒ½',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: funcsCount
                },
                {
                    name: 'Bug',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: bugsCount
                },
                {
                    name: 'éœ€æ±‚ç¡®è®¤',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: demandCount
                },

            ]
        };
        let yMatchTypes = ["æ–°å»º", "å¤„ç†ä¸­", "å·²è§£å†³", "å·²å¿½ç•¥", "å¾…åé¦ˆ", "å·²å…³é—­", "é‡æ–°æ‰“å¼€"]
        let xMatchTypes = ["ä»»åŠ¡", "åŠŸèƒ½", "Bug", "éœ€æ±‚ç¡®è®¤"]

        // ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨ã€‚
        myChart.setOption(option);
        myChart.hideLoading();
        myChart.on("click", function (e) {
            console.log(e.name)
            console.log(e.seriesName)
            console.log(e.seriesName == 'Bug')
            {#alert('chart on click>>', params);#}
            {#console.log((yMatchTypes.indexOf(e.name) + 1))#}
            {#console.log((all_type_ids[(xMatchTypes.indexOf(e.seriesName))]))#}
            if (e.name && e.seriesName) {
                {#alert('issues_types', (xMatchTypes.indexOf(e.seriesName)))#}
                window.location.href = "/manage/" + pid + "/issues/?status=" + (yMatchTypes.indexOf(e.name) + 1) +
                    "&issues_type=" + (all_type_ids[(xMatchTypes.indexOf(e.seriesName))])
            }
        })


        function legendTriggerRefresh() {
            let legend = localStorage.getItem(dashboardLegendTriggerKey);
            console.log('mainLegendTrigger le>>', legend);
            let legendArr = ['ä»»åŠ¡', 'åŠŸèƒ½', 'Bug', 'éœ€æ±‚ç¡®è®¤']
            if (!legend) {
                legend = 'ä»»åŠ¡,åŠŸèƒ½,Bug,éœ€æ±‚ç¡®è®¤'
                localStorage.setItem(dashboardLegendTriggerKey, legend);
            } else {
                if (legend) {
                    let splitLegend = legend.split(",");
                    for (var i = 0; i < 4; i++) {
                        myChart.setOption({
                            legend: {selected: {[legendArr[i]]: false}},
                        })
                    }
                    for (s in splitLegend) {
                        if (splitLegend[s] == 'ä»»åŠ¡') {
                            myChart.setOption({
                                legend: {selected: {['ä»»åŠ¡']: true}}
                            })
                        } else if (splitLegend[s] == 'åŠŸèƒ½') {
                            myChart.setOption({
                                legend: {selected: {['åŠŸèƒ½']: true}}
                            })
                        } else if (splitLegend[s] == 'Bug') {
                            myChart.setOption({
                                legend: {selected: {['Bug']: true}}
                            })
                        } else if (splitLegend[s] == 'éœ€æ±‚ç¡®è®¤') {
                            myChart.setOption({
                                legend: {selected: {['éœ€æ±‚ç¡®è®¤']: true}}
                            })
                        }
                    }

                } else {
                    console.log('mainLegendTrigger', legend)
                    {% comment %}for (var i = 0; i < 5; i++) {
                        myChart.setOption({
                            legend: {selected: {[legendArr[i]]: false}},
                        })
                    }{% endcomment %}
                }
            }
        }

        myChart.on('legendselectchanged', function (e) {
            if (e.selected[e.name]) {
                // ç‚¹å‡»é¡¹æ˜¯é€‰ä¸­çŠ¶æ€
                console.log(e.name + ' checked')
                sendFreshMainEchartLegendTriggerVal(e.selected)
            } else {
                // ç‚¹å‡»é¡¹æ˜¯å–æ¶ˆçŠ¶æ€
                console.log(e.name + ' un checked')
                sendFreshMainEchartLegendTriggerVal(e.selected)
            }
            // do something
        });


        function sendFreshMainEchartLegendTriggerVal(val) {
            let reqVal = ''
            if (val.ä»»åŠ¡) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'ä»»åŠ¡'
            }
            if (val.åŠŸèƒ½) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'åŠŸèƒ½'
            }
            if (val.Bug) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'Bug'
            }
            if (val.éœ€æ±‚ç¡®è®¤) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'éœ€æ±‚ç¡®è®¤'
            }
            console.log(reqVal)
            if (!reqVal) {
                alert('è‡³å°‘ä¿ç•™ä¸€é¡¹ğŸ˜„')
                location.reload();
                return
            }
            $.ajax({
                url: "{% url 'main_echart_legend_cache' project_id=request.web.project.id %}",
                type: "POST",
                data: {
                    "trigger": reqVal,
                    "csrfmiddlewaretoken": $("#csrf_token").val()
                },
                dataType: "JSON",
                success: function (res) {
                    if (res.code) {
                        localStorage.setItem(dashboardLegendTriggerKey, reqVal)
                        console.log("reload")
                        {#legendTriggerRefresh()#}
                        {#reloadWorkBenchJson()#}
                        location.reload();
                        {#$("#tasklist").load(issues_object_list=[])#}
                    } else {

                    }
                }

            })
        }

        //deprecated
        function sendInitDashboardEchartLegendTriggerVal() {
            const initialDashBoardLegend = 'ä»»åŠ¡,åŠŸèƒ½,Bug,éœ€æ±‚ç¡®è®¤'
            $.ajax({
                url: "{% url 'main_echart_legend_cache' project_id=request.web.project.id %}",
                type: "POST",
                data: {
                    "trigger": initialDashBoardLegend,
                    "csrfmiddlewaretoken": $("#csrf_token").val()
                },
                dataType: "JSON",
                success: function (res) {
                    if (res.code) {
                        localStorage.setItem(dashboardLegendTriggerKey, initialDashBoardLegend)
                        console.log("sendInitDashboardEchartLegendTriggerVal reload")
                        {#legendTriggerRefresh()#}
                        {#reloadWorkBenchJson()#}
                        location.reload();
                        {#$("#tasklist").load(issues_object_list=[])#}
                    } else {

                    }
                }

            })
        }

        function mytaskTrigger() {
            console.log("mytaskTrigger")
            let isChecked = $('input[type="checkbox"]').prop('checked');
            if (isChecked) {
                console.log("å‹¾é€‰");
                localStorage.setItem(mytaskTriggerKey, "on")
            } else {
                console.log("æœªå‹¾é€‰");
                localStorage.setItem(mytaskTriggerKey, "off")
            }
            sendFreshTriggerVal()

        }

        function storageTriggerInit() {
            let item = localStorage.getItem(mytaskTriggerKey);
            if (!item) {
                item = 'off'
                localStorage.setItem(mytaskTriggerKey, item);
            } else {
                console.log("mytaskTrigger", item)
                if (item == "on") {
                    $('input[type="checkbox"]').prop('checked', true);
                } else {
                    $('input[type="checkbox"]').prop('checked', false);
                }
            }
            legendTriggerRefresh()
        }

        storageTriggerInit()

        $(function () {
            bindCopyUrl();
        });

        /**
         * ç‚¹å‡»æ‹·è´é“¾æ¥url
         * */
        function bindCopyUrl() {
            $('#btnCopyUrl').click(function () {
                var textInput = $('#inviteUrl')[0]; // document.getElementById('inviteUrl')
                textInput.select();

                document.execCommand("Copy");
                layui.use(function () {
                    var layer = layui.layer;
                    // Welcome
                    layer.msg('å¤åˆ¶æˆåŠŸ', {icon: 6});
                });
            })
        }

        function sendFreshTriggerVal() {
            {#const  pid = {{ request.web.project.id }})#}
            $.ajax({
                url: "{% url 'cache' project_id=request.web.project.id %}",
                type: "POST",
                data: {
                    "trigger": localStorage.getItem(mytaskTriggerKey),
                    "csrfmiddlewaretoken": $("#csrf_token").val()
                },
                dataType: "JSON",
                success: function (res) {
                    console.log(res);
                    if (res.code) {
                        console.log("reload")
                        location.reload();
                    } else {

                    }
                }

            })
        }

        function showMemberWithProjInfos() {
            alert("æš‚æ— ")
        }

        var INVITE_URL = "{% url 'invite_url' project_id=request.web.project.id %}";

        $(function () {
            bindCreateInviteCode();
        });

        /**
         *       ç‚¹å‡»ç”Ÿæˆé‚€è¯·é“¾æ¥
         */
        function bindCreateInviteCode() {
            $('#btnGenInviteCode').click(function () {
                $('.error-msg').empty();
                $.ajax({
                    url: INVITE_URL,
                    type: "POST",
                    data: $('#inviteForm').serialize(),
                    dataType: "JSON",
                    success: function (res) {
                        if (res.status) {
                            $('#inviteArea').removeClass('hide').find('#inviteUrl').val(res.data);
                        } else {
                            $.each(res.error, function (k, v) {
                                $('#id_' + k).next('.error-msg').text(v[0]);
                            })
                        }
                    }
                })
            })
        }


        layui.use(function () {
            var $ = layui.$;

            //æ¼”ç¤ºåŠ¨ç”»
            $('.ws-docs-anim .layui-anim').on('mouseover', function () {
                var othis = $(this), anim = othis.data('anim');

                //åœæ­¢å¾ªç¯
                if (othis.hasClass('layui-anim-loop')) {
                    return othis.removeClass(anim);
                }

                othis.removeClass(anim);

                setTimeout(function () {
                    othis.addClass(anim);
                });
                //æ¢å¤æ¸éš
                if (anim === 'layui-anim-fadeout') {
                    setTimeout(function () {
                        othis.removeClass(anim);
                    }, 1300);
                }
            });
        });

        layui.use(function () {
            var layer = layui.layer;
            var util = layui.util;
            // äº‹ä»¶
            util.on('lay-on', {
                'test-tips-prompt-2': function () {
                    layer.prompt({title: 'è¯·è¾“å…¥æ–‡æœ¬', formType: 2}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        layer.msg('è·å¾—ï¼š' + util.escape(value)); // æ˜¾ç¤º value
                        // å…³é—­ prompt
                        layer.close(index);
                    });
                },
            })
            var form = layui.form;
            var $ = layui.$;
            if (remind_infos.length > 0) {
                let is_link = false
                for (i in remind_infos) {
                    let showCloseAllBtn = true
                    if (remind_infos.length == 1) {
                        console.log('length 1')
                        showCloseAllBtn = false
                    }
                    let ri = remind_infos[i]
                    let btn = []
                    let btn0Name = 'æŸ¥çœ‹è¯¦æƒ…'
                    let btn1Name = 'å›å¤æ¶ˆæ¯'
                    let btn2Name = 'æœ¬æ¬¡å…³é—­'
                    let btn3Name = 'å…¨éƒ¨å…³é—­'
                    let btn4Name = 'ä¸å†æé†’'
                    btn.push(btn0Name)
                    btn.push(btn1Name)
                    btn.push(btn2Name)
                    if (showCloseAllBtn) {
                        btn.push(btn3Name)
                        btn.push(btn4Name)
                    } else {
                        btn.push(btn4Name)
                    }
                    if (ri.link.length > 0) {
                        is_link = true
                    } else {
                    }

                    // äº‹ä»¶
                    //when dashboard receive the deadline news , trigger this deadline card instantly
                    var that = this;
                    // å¤šçª—å£æ¨¡å¼ + å±‚å ç½®é¡¶ + Esc å…³é—­
                    layer.open({
                        type: 1,
                        title: ri.type == 1 ? 'ç³»ç»Ÿä¿¡æ¯ (æŒ‰ESCé”®å¯å…³é—­)' : ri.type == 2 ? 'æé†’ä¿¡æ¯ (æŒ‰ESCé”®å¯å…³é—­)' : '',
                        area: ['390px', '260px'],
                        shade: 0,
                        maxmin: true,
                        offset: [ // ä¸ºäº†ä¾¿äºæ¼”ç¤ºï¼Œæ­¤å¤„é‡‡ç”¨éšæœºåæ ‡
                            Math.random() * ($(window).height() - 300),
                            1 * $(window).width() - 400
                        ],
                        content: '<div style="padding: 16px;">' +
                            '<label style="color: deeppink">' + ri.content + '</label>' +
                            '</div>',
                        btn: btn,
                        yes: function () {
                            {#$(that).click();#}
                            if (is_link) {
                                window.open(ri.link)
                                //set the msg already readed through ajax
                            } else {
                                //todo reply hint msg
                            }
                        },
                        {% comment %} btn1: function () {
                             layer.msg('btn1 ', {icon: 1});
                         },{% endcomment %}
                        btn2: function () {
                            console.log('click btn2  ', btn[1])
                            {#layer.close();#}
                        },
                        btn3: function () {
                            layer.close();
                            console.log('click btn3  ', btn[2])
                            layer.msg('å†æ¬¡æŸ¥çœ‹å¯ä»æé†’å¤„æŸ¥çœ‹', {icon: 7})
                        },
                        btn4: function () {
                            if (showCloseAllBtn) {
                                layer.closeAll();
                                console.log('click btn4  ', btn[3])
                                layer.msg('å†æ¬¡æŸ¥çœ‹å¯ä»æé†’å¤„æŸ¥çœ‹', {icon: 7})
                            } else {
                                console.log('click btn4 ', btn[4])
                                status(ri.id)
                                layer.msg('å·²å°†çŠ¶æ€æ›´æ”¹åˆ°å·²è¯»', {icon: 1})
                            }
                        },
                        btn5: function () {
                            console.log('click btn4 ', btn[4])
                            status(ri.id)
                            layer.msg('å·²å°†çŠ¶æ€æ›´æ”¹åˆ°å·²è¯»', {icon: 1})
                        },
                        zIndex: layer.zIndex, // é‡ç‚¹ 1 --- åˆå§‹è®¾ç½®å½“å‰æœ€é«˜å±‚å é¡ºåºï¼Œ
                        success: function (layero, index) {
                            layer.setTop(layero); // é‡ç‚¹ 2 --- ä¿æŒé€‰ä¸­çª—å£ç½®é¡¶

                            // è®°å½•ç´¢å¼•ï¼Œä»¥ä¾¿æŒ‰ esc é”®å…³é—­ã€‚äº‹ä»¶è§ä»£ç æœ€æœ«å°¾å¤„ã€‚
                            layer.escIndex = layer.escIndex || [];
                            layer.escIndex.unshift(index);
                            // é€‰ä¸­å½“å‰å±‚æ—¶ï¼Œå°†å½“å‰å±‚ç´¢å¼•æ”¾ç½®åœ¨é¦–ä½
                            layero.on('mousedown', function () {
                                var _index = layer.escIndex.indexOf(index);
                                if (_index !== -1) {
                                    layer.escIndex.splice(_index, 1); //åˆ é™¤åŸæœ‰ç´¢å¼•
                                }
                                layer.escIndex.unshift(index); //å°†ç´¢å¼•æ’å…¥åˆ°æ•°ç»„é¦–ä½
                            });
                        },
                        end: function () {
                            //æ›´æ–°ç´¢å¼•
                            if (typeof layer.escIndex === 'object') {
                                layer.escIndex.splice(0, 1);
                            }
                        }
                    });
                }
            }
            // å¤šçª—å£æ¨¡å¼ - esc é”®
            $(document).on('keyup', function (e) {
                if (e.keyCode === 27) {
                    layer.close(layer.escIndex ? layer.escIndex[0] : 0);
                }
            });
        });

        function status(key) {
            $.ajax({
                url: "{% url 'remind_status' project_id=request.web.project.id %}",
                type: "POST",
                data: {
                    "id": key,
                    "csrfmiddlewaretoken": $("#csrf_token").val()
                },
                dataType: "JSON",
                success: function (res) {
                    if (res.status) {
                        location.reload();
                        {#$("#badge").load(location.href + " #badge")#}
                    } else {
                    }
                }
            })
        }


        layui.use(function () {
            var layer = layui.layer;
            var util = layui.util;
            // äº‹ä»¶
            util.on('lay-on', {
                'test-tips-tab': function () {
                    layer.tab({
                        area: ['600px', '300px'],
                        tab: [{
                            title: 'Title 1',
                            content: '<div style="padding: 16px;">tabs content 111</div>'
                        }, {
                            title: 'Title 2',
                            content: '<div style="padding: 16px;">tabs content 222</div>'
                        }, {
                            title: 'Title 3',
                            content: '<div style="padding: 16px;">tabs content 333</div>'
                        }],
                        shadeClose: true
                    });
                },
                'test-tips-prompt-0': function () {
                    layer.prompt({title: 'è¯·è¾“å…¥æ–‡æœ¬'}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        layer.msg('è·å¾—ï¼š' + util.escape(value)); // æ˜¾ç¤º value
                        // å…³é—­ prompt
                        layer.close(index);
                    });
                },
                'test-tips-prompt-1': function () {
                    layer.prompt({title: 'è¯·è¾“å…¥å¯†ä»¤', formType: 1}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        layer.msg('è·å¾—ï¼š' + util.escape(value)); // æ˜¾ç¤º value
                        // å…³é—­ prompt
                        layer.close(index);
                    });
                },
                'test-tips-prompt-2': function () {
                    layer.prompt({title: 'è¯·è¾“å…¥æ–‡æœ¬', formType: 2}, function (value, index, elem) {
                        if (value === '') return elem.focus();
                        layer.msg('è·å¾—ï¼š' + util.escape(value)); // æ˜¾ç¤º value
                        // å…³é—­ prompt
                        layer.close(index);
                    });
                },
                'test-tips-photos-one': function () {
                    layer.photos({
                        photos: {
                            "title": "Photos Demo",
                            "start": 0,
                            "data": [
                                {
                                    "alt": "æµ©ç€šå®‡å®™",
                                    "pid": 5,
                                    "src": "https://unpkg.com/outeres@0.1.1/demo/outer-space.jpg",
                                }
                            ]
                        },
                        footer: false // æ˜¯å¦æ˜¾ç¤ºåº•éƒ¨æ  --- 2.8.16+
                    });
                },
                'test-tips-photos': function () {
                    layer.photos({
                        photos: {
                            "title": "Photos Demo",
                            "start": 0,
                            "data": [
                                {
                                    "alt": "layer",
                                    "pid": 1,
                                    "src": "https://unpkg.com/outeres@0.1.1/demo/layer.png",
                                },
                                {
                                    "alt": "å£çº¸",
                                    "pid": 3,
                                    "src": "https://unpkg.com/outeres@0.1.1/demo/000.jpg",
                                },
                                {
                                    "alt": "æµ©ç€šå®‡å®™",
                                    "pid": 5,
                                    "src": "https://unpkg.com/outeres@0.1.1/demo/outer-space.jpg",
                                }
                            ]
                        }
                    });
                }
            })
        });
    </script>

{% endblock %}