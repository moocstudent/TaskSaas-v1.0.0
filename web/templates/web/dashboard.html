{% extends 'layout/manage.html' %}
{% load dashboard %}
{% load issues %}
{% block title %}{% endblock %}

{% block css %}
    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 17px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .table-right > tbody > tr > td.label-left {
            width: 90px;
        }

        .table-right > tbody > tr > td {
            border: 0;
        }

        .status-count {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-count .count {
            font-size: 25px;
        }

        .status-count a {
            text-decoration: none;
        }

        .user-item .title {
            margin-bottom: 20px;
        }

        .user-item .avatar, .top-10 .avatar {
            float: left;
            margin-right: 10px;
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: #304659;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
        }

        .user-item .text {
            line-height: 30px;
        }

        .top-10 .avatar {
            margin-right: 0;
        }

        .top-10 td {
            padding: 5px 10px;
        }

        .top-10 .table > tbody > tr > td {
            border-top: 0;
            border-bottom: 1px solid #ddd;
        }
    </style>

{% endblock %}

{% block content %}
    <div class="container-fluid" style="margin-top: 20px">
        <div class="row">

            <div class="col-md-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-bar-chart" aria-hidden="true"></i>
                        Êñ∞Â¢ûÈóÆÈ¢òË∂ãÂäø
                        <label class="fa! switch">
                            <input type="checkbox" id="mytaskToggle" onclick="mytaskTrigger()">
                            <span class="slider round"></span>
                        </label>
                        Âè™Áúã‰∏éÊàëÁõ∏ÂÖ≥
                    </div>
                    <div class="panel-body">
                        <div id="chart" style="width:100%;min-height:200px">

                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="fa fa-quora" aria-hidden="true"></i>
                                ÈóÆÈ¢ò
                            </div>
                            <div class="panel-body">
                                {% for key,item in status_dict.items %}
                                    <div class="col-sm-4 status-count">
                                        <a href="{% url 'issues' project_id=request.web.project.id %}?status={{ key }}&issues_type={{ type_ids }}">
                                            <div class="count">{{ item.count }}</div>
                                            <div>{{ item.text }}</div>
                                        </a>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <i class="fa fa-user" aria-hidden="true"></i>
                                È°πÁõÆÊàêÂëò
                            </div>
                            <div class="panel-body user-item">
                                <div class="col-sm-12 title">ÂàõÂª∫ËÄÖ</div>
                                <div class="clearfix" style="margin-bottom: 30px;">
                                    <div class="col-sm-4">
                                        {#                                       id {{ request.web.project.creator.id }}#}
                                        <a href="" onclick="showMemberWithProjInfos()">
                                            <div class="avatar">{{ request.web.project.creator.username.0|upper }}</div>
                                        </a>
                                        <div class="text">{{ request.web.project.creator.username }}</div>
                                    </div>
                                </div>
                                <div class="col-sm-12 title">ÂèÇ‰∏éËÄÖ</div>
                                <div>
                                    {% for item in join_user %}
                                        <div class="col-sm-4">
                                            {#                                        id {{ item.0 }}#}
                                            <a href="" onclick="showMemberWithProjInfos()">
                                                <div class="avatar">{{ item.1.0 |upper }}</div>
                                            </a>
                                            <div class="text">{{ item.1 }}</div>
                                        </div>
                                    {% endfor %}
                                </div>

                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <div class="col-md-4">

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-cog title-icon"></i>
                        ËØ¶ÁªÜ
                    </div>
                    <div class="panel-body">
                        <table class="table table-right">
                            <tbody>
                            <tr>
                                <td class="label-left">È°πÁõÆÂêçÁß∞ Ôºö</td>
                                <td>{{ request.web.project.name }}-({{ request.web.project.id }})</td>

                            </tr>
                            <tr>
                                <td class="label-left">È°πÁõÆÊèèËø∞ Ôºö</td>
                                <td>{{ request.web.project.desc }}</td>
                            </tr>
                            <tr>
                                <td class="label-left">ÂàõÂª∫Êó∂Èó¥ Ôºö</td>
                                <td>{{ request.web.project.create_datetime }}</td>
                            </tr>
                            <tr>
                                <td class="label-left">È°πÁõÆÁ©∫Èó¥ Ôºö</td>
                                <td> {% user_space request.web.project.user_space %}
                                    / {{ request.web.price_policy.project_space }} GB
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-list-ul" aria-hidden="true"></i>
                        Âä®ÊÄÅ
                    </div>
                    <div class="panel-body top-10">
                        <table class="table">
                            <tbody>
                            {% for key,item in top_ten.items %}
                                {#                                                                {{ key }}#}
                                {#                                {{ item }}#}
                                <tr>
                                    <td style="width: 46px;">
                                        <div class="avatar">{{ item.creator.0|upper }}</div>
                                    </td>
                                    <td>
                                        {% if item.is_fresh %}
                                            {% if not item.is_assign %}
                                                <div>{{ item.creator }}</div>
                                                <label>
                                                    Êõ¥Êñ∞‰∫Ü
                                                    <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                    {#                                            Áªô {{ item.assign.username }}#}
                                                    <label>„Äê{{ item.title }}„Äë</label>
                                                </label>
                                                <label style="width: 300px;">
                                                    Êõ¥Êñ∞‰∫é:{{ key }}
                                                </label>
                                            {% endif %}
                                        {% endif %}
                                        {% if item.is_assign and item.assign %}
                                            <div>{{ item.creator }}</div>
                                            <label>Êõ¥Êñ∞‰∫ÜÊåáÊ¥æ
                                                <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                {#                                            Áªô {{ item.assign.username }}#}
                                                <label>„Äê{{ item.title }}„Äë</label>
                                            </label>
                                            <label>ÊåáÊ¥æ
                                                Áªô {{ item.assign }}
                                            </label>
                                            <label style="width: 300px;">
                                                ÊåáÊ¥æ‰∫é:{{ key }}
                                            </label>
                                        {% endif %}
                                        {% if item.is_reply %}
                                            <div>{{ item.creator }}</div>
                                            {% if item.reply_type == 1 %}
                                                <label>Êõ¥Êñ∞‰∫Ü
                                                    <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                    {#                                            Áªô {{ item.assign.username }}#}
                                                    <label>„Äê{{ item.title }}„Äë</label>
                                                    <label>{{ item.desc }}</label>
                                                </label>
                                                {#                                            <div>ÊåáÊ¥æ#}
                                                {#                                                Áªô {{ item.assign }}#}
                                                {#                                            </div>#}
                                                <label style="width: 300px;">
                                                    Êõ¥Êñ∞‰∫é:{{ key }}
                                                </label>
                                            {% else %}
                                                <label>ÂõûÂ§ç‰∫Ü
                                                    <a href="{% url 'issues_detail' project_id=request.web.project.id issues_id=item.issue_id %}">{% string_just item.issue_id %}</a>
                                                    {#                                            Áªô {{ item.assign.username }}#}
                                                    <label>„Äê{{ item.title }}„Äë</label>
                                                    <label>{{ item.desc }}</label>
                                                </label>
                                                {#                                            <div>ÊåáÊ¥æ#}
                                                {#                                                Áªô {{ item.assign }}#}
                                                {#                                            </div>#}
                                                <label style="width: 300px;">
                                                    ÂõûÂ§ç‰∫é:{{ key }}
                                                </label>
                                            {% endif %}

                                        {% endif %}

                                    </td>

                                </tr>

                            {% endfor %}
                            </tbody>
                        </table>

                    </div>
                </div>

            </div>
        </div>
    </div>
    <div {% load dashboard %} hidden="hidden"></div>
    <input id="echarts_data" value="{{ echarts_data }}" hidden="hidden"/>
    <input id="tasks_count" value="{{ tasks_count }}" hidden="hidden"/>
    <input id="funcs_count" value="{{ funcs_count }}" hidden="hidden"/>
    <input id="bugs_count" value="{{ bugs_count }}" hidden="hidden"/>
    <input id="demand_count" value="{{ demand_count }}" hidden="hidden"/>
    <input id="issues_types" value="{{ issues_types }}" hidden="hidden"/>
    <input id="status_choices" value="{{ status_choices }}" hidden="hidden"/>
    <input id="pid" value="{{ request.web.project.id }}" hidden="hidden"/>
    <input id="type_ids" value="{{ type_ids }}" hidden="hidden"/>
    <input id="all_type_ids" value="{{ all_type_ids }}" hidden="hidden"/>
    <input id="csrf_token" value="{{ csrf_token }}" hidden="hidden"/>
{% endblock %}

{% block js %}
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById("chart"));
        var echartsData = JSON.parse(document.getElementById("echarts_data").value);
        console.log('echartsData', echartsData);
        const yDataNames = ['ÈáçÊñ∞ÊâìÂºÄ', 'Â∑≤ÂÖ≥Èó≠', 'ÂæÖÂèçÈ¶à', 'Â∑≤ÂøΩÁï•', 'Â∑≤Ëß£ÂÜ≥', 'Â§ÑÁêÜ‰∏≠', 'Êñ∞Âª∫']
        var tasksCount = JSON.parse(document.getElementById("tasks_count").value);
        console.log('tasksCount', tasksCount);
        if (tasksCount.length == 0) {
            console.log('rray(yDataNames.lengt')
            tasksCount = Array(yDataNames.length).fill(0);
        }
        var funcsCount = JSON.parse(document.getElementById("funcs_count").value);
        if (funcsCount.length == 0) {
            funcsCount = Array(yDataNames.length).fill(0);
        }
        console.log('funcsCount', funcsCount)
        var bugsCount = JSON.parse(document.getElementById("bugs_count").value);
        if (bugsCount.length == 0) {
            bugsCount = Array(yDataNames.length).fill(0);
        }
        var demandCount = JSON.parse(document.getElementById("demand_count").value);
        if (demandCount.length == 0) {
            demandCount = Array(yDataNames.length).fill(0);
        }
        var issues_types = eval(document.getElementById("issues_types"));
        var status_choices = JSON.parse(document.getElementById("status_choices").value);
        var type_ids = document.getElementById("type_ids").value;
        var all_type_ids = document.getElementById("all_type_ids").value;
        if (type_ids) {
            {#if (type_ids.indexOf(",")>-1){#}
            type_ids = type_ids.split(',')
            {% comment %}  }{% endcomment %}
        }
        if (all_type_ids) {
            {#if (type_ids.indexOf(",")>-1){#}
            all_type_ids = all_type_ids.split(',')
            {% comment %}  }{% endcomment %}
        }
        var pid = JSON.parse(document.getElementById("pid").value);

        const dashboardLegendTriggerKey = "mainLegendTrigger"+'{{ request.web.user.id }}'+'_'+'{{ request.web.project.id }}'
        console.log('dashboardLegendTriggerKey',dashboardLegendTriggerKey)

        const mytaskTriggerKey = "mytaskTrigger"+'{{ request.web.user.id }}'+'_'+'{{ request.web.project.id }}'
        console.log('mytaskTriggerKey',mytaskTriggerKey)


        // Âü∫‰∫éÂáÜÂ§áÂ•ΩÁöÑdomÔºåÂàùÂßãÂåñechartsÂÆû‰æã
        myChart.showLoading();

        // ÊåáÂÆöÂõæË°®ÁöÑÈÖçÁΩÆÈ°πÂíåÊï∞ÊçÆ
        {% comment %}   var option = {
            // title: {
              // text: 'ECharts ÂÖ•Èó®Á§∫‰æã'
             //},
             tooltip: {},
             legend: {
               data: ['ÂÆåÊàêÈáè']
             },
             xAxis: {
               data: ['Êñ∞Âª∫', 'Â§ÑÁêÜ‰∏≠', 'Â∑≤Ëß£ÂÜ≥', 'Â∑≤ÂøΩÁï•', 'ÂæÖÂèçÈ¶à', 'Â∑≤ÂÖ≥Èó≠','ÈáçÊñ∞ÊâìÂºÄ']
             },
             yAxis: {},
             series: [
               {
                 name: 'ÂÆåÊàêÈáè',
                 type: 'bar',
                 data: echartsData
               }
             ]
           };{% endcomment %}

        option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    // Use axis to trigger tooltip
                    type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
                }
            },
            legend: {},
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'value',
                triggerEvent: true,
            },
            yAxis: {
                type: 'category',
                data: yDataNames,
                triggerEvent: true,
            },
            series: [
                {
                    name: '‰ªªÂä°',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: tasksCount
                },
                {
                    name: 'ÂäüËÉΩ',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: funcsCount
                },
                {
                    name: 'Bug',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: bugsCount
                },
                {
                    name: 'ÈúÄÊ±ÇÁ°ÆËÆ§',
                    type: 'bar',
                    stack: 'total',
                    label: {
                        show: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: demandCount
                },

            ]
        };
        let yMatchTypes = ["Êñ∞Âª∫", "Â§ÑÁêÜ‰∏≠", "Â∑≤Ëß£ÂÜ≥", "Â∑≤ÂøΩÁï•", "ÂæÖÂèçÈ¶à", "Â∑≤ÂÖ≥Èó≠", "ÈáçÊñ∞ÊâìÂºÄ"]
        let xMatchTypes = ["‰ªªÂä°", "ÂäüËÉΩ", "Bug", "ÈúÄÊ±ÇÁ°ÆËÆ§"]

        // ‰ΩøÁî®ÂàöÊåáÂÆöÁöÑÈÖçÁΩÆÈ°πÂíåÊï∞ÊçÆÊòæÁ§∫ÂõæË°®„ÄÇ
        myChart.setOption(option);
        myChart.hideLoading();
        myChart.on("click", function (e) {
            console.log(e.name)
            console.log(e.seriesName == 'Bug')
            {#alert('chart on click>>', params);#}
            {#console.log((yMatchTypes.indexOf(e.name) + 1))#}
            {#console.log((all_type_ids[(xMatchTypes.indexOf(e.seriesName))]))#}
            if (e.name && e.seriesName) {
                {#alert('issues_types', (xMatchTypes.indexOf(e.seriesName)))#}
                window.location.href = "/manage/" + pid + "/issues/?status=" + (yMatchTypes.indexOf(e.name) + 1) +
                    "&issues_type=" + (all_type_ids[(xMatchTypes.indexOf(e.seriesName))])
            }
        })


        function legendTriggerRefresh() {
            let legend = localStorage.getItem(dashboardLegendTriggerKey);
            console.log('mainLegendTrigger le>>', legend);
            let legendArr = ['‰ªªÂä°', 'ÂäüËÉΩ', 'Bug', 'ÈúÄÊ±ÇÁ°ÆËÆ§']
            if (!legend) {
                legend = '‰ªªÂä°,ÂäüËÉΩ,Bug,ÈúÄÊ±ÇÁ°ÆËÆ§'
            }
            if (legend) {
                let splitLegend = legend.split(",");
                for (var i = 0; i < 4; i++) {
                    myChart.setOption({
                        legend: {selected: {[legendArr[i]]: false}},
                    })
                }
                for (s in splitLegend) {
                    if (splitLegend[s] == '‰ªªÂä°') {
                        myChart.setOption({
                            legend: {selected: {['‰ªªÂä°']: true}}
                        })
                    } else if (splitLegend[s] == 'ÂäüËÉΩ') {
                        myChart.setOption({
                            legend: {selected: {['ÂäüËÉΩ']: true}}
                        })
                    } else if (splitLegend[s] == 'Bug') {
                        myChart.setOption({
                            legend: {selected: {['Bug']: true}}
                        })
                    } else if (splitLegend[s] == 'ÈúÄÊ±ÇÁ°ÆËÆ§') {
                        myChart.setOption({
                            legend: {selected: {['ÈúÄÊ±ÇÁ°ÆËÆ§']: true}}
                        })
                    }
                }

            } else {
                console.log('mainLegendTrigger', legend)
                {% comment %}for (var i = 0; i < 5; i++) {
                    myChart.setOption({
                        legend: {selected: {[legendArr[i]]: false}},
                    })
                }{% endcomment %}
            }
        }

        myChart.on('legendselectchanged', function (e) {
            if (e.selected[e.name]) {
                // ÁÇπÂáªÈ°πÊòØÈÄâ‰∏≠Áä∂ÊÄÅ
                console.log(e.name + ' checked')
                sendFreshMainEchartLegendTriggerVal(e.selected)
            } else {
                // ÁÇπÂáªÈ°πÊòØÂèñÊ∂àÁä∂ÊÄÅ
                console.log(e.name + ' un checked')
                sendFreshMainEchartLegendTriggerVal(e.selected)
            }
            // do something
        });


        function sendFreshMainEchartLegendTriggerVal(val) {
            let reqVal = ''
            if (val.‰ªªÂä°) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += '‰ªªÂä°'
            }
            if (val.ÂäüËÉΩ) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'ÂäüËÉΩ'
            }
            if (val.Bug) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'Bug'
            }
            if (val.ÈúÄÊ±ÇÁ°ÆËÆ§) {
                if (reqVal.length > 0) {
                    reqVal += ','
                }
                reqVal += 'ÈúÄÊ±ÇÁ°ÆËÆ§'
            }
            console.log(reqVal)
            if (!reqVal) {
                alert('Ëá≥Â∞ë‰øùÁïô‰∏ÄÈ°πüòÑ')
                location.reload();
                return
            }
            $.ajax({
                url: "{% url 'main_echart_legend_cache' %}",
                type: "POST",
                data: {
                    "trigger": reqVal,
                    "csrfmiddlewaretoken": $("#csrf_token").val()
                },
                dataType: "JSON",
                success: function (res) {
                    if (res.code) {
                        localStorage.setItem(dashboardLegendTriggerKey, reqVal)
                        console.log("reload")
                        {#legendTriggerRefresh()#}
                        {#reloadWorkBenchJson()#}
                        location.reload();
                        {#$("#tasklist").load(issues_object_list=[])#}
                    } else {

                    }
                }

            })
        }

        function mytaskTrigger() {
            console.log("mytaskTrigger")
            let isChecked = $('input[type="checkbox"]').prop('checked');
            if (isChecked) {
                console.log("ÂãæÈÄâ");
                localStorage.setItem(mytaskTriggerKey, "on")
            } else {
                console.log("Êú™ÂãæÈÄâ");
                localStorage.setItem(mytaskTriggerKey, "off")
            }
            sendFreshTriggerVal()

        }

        function storageTriggerInit() {
            let item = localStorage.getItem(mytaskTriggerKey);
            console.log("mytaskTrigger", item)
            if (item == "on") {
                $('input[type="checkbox"]').prop('checked', true);
            } else {
                $('input[type="checkbox"]').prop('checked', false);
            }
            legendTriggerRefresh()
        }

        storageTriggerInit()

        function sendFreshTriggerVal() {
            $.ajax({
                url: "{% url 'cache' %}",
                type: "POST",
                data: {
                    "trigger": localStorage.getItem(mytaskTriggerKey),
                    "csrfmiddlewaretoken": $("#csrf_token").val()
                },
                dataType: "JSON",
                success: function (res) {
                    console.log(res);
                    if (res.code) {
                        console.log("reload")
                        location.reload();
                    } else {

                    }
                }

            })
        }

        function showMemberWithProjInfos() {
            alert("ÊöÇÊó†")
        }


    </script>
{% endblock %}